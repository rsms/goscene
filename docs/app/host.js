((g,h)=>{let i=function(){return this}(),e={},f=(c,d)=>{if(typeof c==="number"){let a=e[c],b;return a||(a=e[c]={exports:{}},g[c].call(i,f,a.exports,a)),b=a.exports,d&&(!b||!b.__esModule)&&((!b||typeof b!=="object")&&(b={}),"default"in b||Object.defineProperty(b,"default",{get:()=>a.exports,enumerable:!0})),b}Object.defineProperty(c,"__esModule",{value:!0});for(let a in d)Object.defineProperty(c,a,{get:d[a],enumerable:!0})};return f(h)})({0(M){var N={};M(N,{FPSPanel:()=>I,Float64RingBuffer:()=>H,StatPanel:()=>z,Stats:()=>sa,fmtByteSize:()=>J});const Ca=console.log.bind(console);class H{constructor(a){this.buf=new Float64Array(a),this.start=0,this.end=0,this.length=0}reset(a){this.buf=new Float64Array(a),this.start=0,this.end=0,this.length=0}push(a){let b=this.end;this.length==this.buf.length?(this.start++,b=b%this.length):this.length++,this.end++,this.buf[b]=a}sum(){return this.buf.reduce((a,b)=>a+b,0)}avg(){return this.length>0?this.sum()/this.length:0}toString(){return"["+this.buf.subarray(0,this.length).join(" ")+"]"}}class z{constructor(a,b,d){this.name=a,this.data=document.createTextNode(d||"-"),this.unit=document.createTextNode(b),this.el=document.createElement("div"),this.el.className=a,this.el.appendChild(this.data),this.el.appendChild(this.unit),this.frameSamples=null,this.lastRefreshTime=0,this.updateInterval=100,this.needsFrameSamples=!0}set value(a){this.data.nodeValue=a}resetFrameSamples(a){this.needsFrameSamples&&(this.frameSamples=new H(a))}_update(a,b){this.needsFrameSamples&&this.onFrame(a,b),this.lastRefreshTime==0?(this.needsFrameSamples||this.update(a),this.lastRefreshTime=a):a-this.lastRefreshTime>=this.updateInterval&&(this.update(a),this.lastRefreshTime=a)}update(a){}onFrame(a,b){}}class I extends z{constructor(){super("fps"," FPS")}onFrame(a,b){this.frameSamples.push(b)}update(){this.value=Math.round(1000/this.frameSamples.avg())}}class sa{constructor(){this.rootElement=document.createElement("div"),this.rootElement.className="webglstats",this.panels=[],this.lastTime=-1,this.nominalRefreshRate=0,ta(20).then(a=>{this.nominalRefreshRate=Math.ceil(a);for(let b of this.panels)b.resetFrameSamples(this.nominalRefreshRate)}),this.addPanel(new I());if(self.performance&&self.performance.memory){const a=self.performance.memory;this.addGenericPanel(()=>`JS ${J(a.usedJSHeapSize)}`)}}mount(a){a.appendChild(this.rootElement)}unmount(){this.rootElement.parent.removeChild(rootElement)}addPanel(a){return this.rootElement.appendChild(a.el),this.panels.push(a),a}addGenericPanel(a,b){b||(b=a,a={}),this.addPanel(new class extends z{constructor(){super("generic",""),this.needsFrameSamples=!1;for(let d in a)this[d]=a[d]}update(d){this.data.nodeValue=b(d)}}())}update(a){let b=this.nominalRefreshRate==0;if(this.lastTime>=0){let d=a-this.lastTime;for(let f of this.panels)(!f.needsFrameSamples||!b)&&f._update(a,d)}this.lastTime=a}}function ta(a){return new Promise(b=>{let d=1e+10,f=-1;var c=e=>{if(f>=0){d=Math.min(d,e-f);if(a--<1)return b(1000/d)}f=e,requestAnimationFrame(c)};requestAnimationFrame(c)})}function J(a){return a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} kB`:a<1024*1024*1024?`${(a/(1024*1024)).toFixed(1)} MB`:`${(a/1024).toFixed(2)}GB`}
const u=console.log.bind(console);function q(a,b){}function xa(a){return a<<16>>16}function ya(a){return a&65535}function za(a){return a>>0}function i(a){return a>>>0}const O=i(2),P=i(3),Q=i(10),R=i(11),S=i(12),T=i(13),U=i(14),V=i(15),W=i(1000),X=i(1001),Y=i(1002),Z=i(1003),_=i(1004),$=i(1005),aa=i(1006),ba=i(1007),ca=i(1008),da=i(1009),ea=i(1010),fa=i(1011),ga=i(1012),ha=i(1013),ia=i(1014),ja=i(1015),ka=i(1016),la=i(1017),ma=i(1018),na=i(1019),Aa=0,B=1,C=2,D=3,E=4,y=5;function F(a){switch(a){case B:return"EVWindowResize";case C:return"EVPointerMove";case D:return"EVPointerDown";case E:return"EVPointerUp";case y:return"EVAnimationFrame";default:return"(EV?)"}}const x={};function j(a,b,d){let f=x[a];f||(x[a]=f=[]),q(!f[b],`duplicate hostcall handler ${a}[${b}]`),f[b]=d}j("u32_",O,(a,b)=>{s.eventSubscribe(b)}),j("u32_",P,(a,b)=>{s.eventUnsubscribe(b)}),j("__",V,a=>{s.updateAnimationStats(performance.now())}),j("_f64",R,()=>window.devicePixelRatio||1),j("_f64",S,()=>performance.now()*1000);const oa=Date.now()-performance.now();j("_f64",T,()=>(oa+performance.now())*1000),j("_u32x2",Q,()=>[window.innerWidth,window.innerHeight]),j("vu8_i32",U,(a,b,d)=>{let f=new Uint8Array(a.buf,d,b);return crypto.getRandomValues(f).length}),j("vi32_i32",123,(a,b,d)=>{u("hostcall",{argaddr:d,argc:b});for(let f=d+b*4;d<f;d+=4)u(`  val#${b-(f-d)/4}`,a.getInt32(d))}),j("j_u32x2",W,(a,b)=>[b.drawingBufferWidth,b.drawingBufferHeight]),j("j_u32x2",X,(a,b)=>[b.canvas.clientWidth,b.canvas.clientHeight]),j("jvi32_",Y,(a,b,d,f)=>{q(d==4);let c=a.getInt32(f),e=a.getInt32(f+4),g=a.getInt32(f+8),h=a.getInt32(f+12);b.viewport(c,e,g,h)}),j("ju32j_",ca,(a,b,d,f)=>{b.bindBuffer(d,f)}),j("ju32_",Z,(a,b,d)=>{b.clear(d)}),j("ju32_",aa,(a,b,d)=>{b.enable(d)}),j("ju32_",ba,(a,b,d)=>{b.depthFunc(d)}),j("jvf32_",_,(a,b,d,f)=>{q(d==4);let c=a.getFloat32(f),e=a.getFloat32(f+4),g=a.getFloat32(f+8),h=a.getFloat32(f+12);b.clearColor(c,e,g,h)}),j("jf32_",$,(a,b,d)=>{b.clearDepth(d)}),j("jvu32_",da,(a,b,d,f)=>{q(d==4);const c=a.getUint32(f),e=a.getUint32(f+4),g=a.getUint32(f+8),h=a.getUint32(f+12);b.bufferData(c,new Uint8Array(a.buf,g,h),e)}),j("jvu32_",ea,(a,b,d,f)=>{q(d==6);const c=a.getUint32(f),e=a.getUint32(f+4),g=a.getUint32(f+8),h=a.getUint32(f+12),k=a.getUint32(f+16),l=a.getUint32(f+20);b.vertexAttribPointer(c,e,g,h,k,l)}),j("ju32x3_",ma,(a,b,d,f,c)=>{b.drawArrays(d,f,c)}),j("ju32x4_",na,(a,b,d,f,c,e)=>{b.drawElements(d,f,c,e)});for(let[a,b]of[[2,ha],[3,ia],[4,ja]]){const d=WebGLRenderingContext.prototype[`uniformMatrix${a}fv`],f=a*a;j("jx2vu32_",b,(c,e,g,h,k)=>{q(h==2);const l=c.getUint32(k),n=c.getUint32(k+4),p=new Float32Array(c.buf,n,f);d.call(e,g,l,p)})}j("jx2vf32_",ka,(a,b,d,f,c)=>{if(f==1)b.uniform1f(d,a.getFloat32(c));else{const e=new Float32Array(a.buf,c,f);if(f==2)b.uniform2fv(d,e);else if(f==3)b.uniform3fv(d,e);else if(f==4)b.uniform4fv(d,e);else throw new Error(`invalid value count ${f}`)}}),j("jx2vi32_",la,(a,b,d,f,c)=>{if(f==1)b.uniform1i(d,a.getInt32(c));else{const e=new Int32Array(a.buf,c,f);if(f==2)b.uniform2iv(d,e);else if(f==3)b.uniform3iv(d,e);else if(f==4)b.uniform4iv(d,e);else throw new Error(`invalid value count ${f}`)}}),j("ju32_",fa,(a,b,d)=>{b.enableVertexAttribArray(d)}),j("jx2_",ga,(a,b,d)=>{b.useProgram(d)});class pa{constructor(a){this.go=a,this.buf=null,this.view=null,this.version=0}check(){let a=this.go._inst.exports.mem.buffer;return this.buf!==a&&(this.buf=a,this.view=new DataView(a),this.version++),this}getInt8(a){return this.view.getInt8(a,!0)}getUint8(a){return this.view.getUint8(a,!0)}getInt16(a){return this.view.getInt16(a,!0)}getUint16(a){return this.view.getUint16(a,!0)}getInt32(a){return this.view.getInt32(a,!0)}getUint32(a){return this.view.getUint32(a,!0)}getFloat32(a){return this.view.getFloat32(a,!0)}getFloat64(a){return this.view.getFloat64(a,!0)}getBigInt64(a){return this.view.getBigInt64(a,!0)}getBigUint64(a){return this.view.getBigUint64(a,!0)}setInt8(a,b){return this.view.setInt8(a,b,!0)}setUint8(a,b){return this.view.setUint8(a,b,!0)}setInt16(a,b){return this.view.setInt16(a,b,!0)}setUint16(a,b){return this.view.setUint16(a,b,!0)}setInt32(a,b){return this.view.setInt32(a,b,!0)}setUint32(a,b){return this.view.setUint32(a,b,!0)}setFloat32(a,b){return this.view.setFloat32(a,b,!0)}setFloat64(a,b){return this.view.setFloat64(a,b,!0)}setBigInt64(a,b){return this.view.setBigInt64(a,b,!0)}setBigUint64(a,b){return this.view.setBigUint64(a,b,!0)}getInt64(a){const b=this.view.getUint32(a+0,!0),d=this.view.getInt32(a+4,!0);return b+d*4.294967296e+09}setInt64(a,b){this.view.setUint32(a+0,b,!0),this.view.setUint32(a+4,Math.floor(b/4.294967296e+09),!0)}getUint8Slice(a){const b=this.getInt64(a),d=this.getInt64(a+8);return new Uint8Array(this.buf,b,d)}getInt32Slice(a){const b=this.getInt64(a),d=this.getInt64(a+8);return new Int32Array(this.buf,b,d)}getJSObject(a){const b=this.getUint32(a);return this.go._values[b]}}const s=new class a{constructor(){this.eventMsgBuf=new ArrayBuffer(4096),this.eventMsgView=new DataView(this.eventMsgBuf),this.wasmInstance=null,this.eventSubscriptions=new Set(),this.transientEvents=new Map(),this.persistentEvents=new Map(),this.persistentEventsVersion=0,this.runloopTickFunc=null;let b=this.go=new Go(),d=new pa(b);this.gomem=d;function f(c,e){Array.isArray(c)||(c=[c]);for(let g of c){const h=x[g];q(h,`no hostcallHandlers[sig=${g}]`),delete x[g],b.importObject.go["main.hostcall_"+g]=k=>{const l=d.check(),n=l.getInt32(k+8),p=h[n];if(!p)throw new Error(`invalid hostcall_${g} #${n}`);k+=16,e(l,k,p)}}}f("__",(c,e,g)=>{g(c)}),f("_f64",(c,e,g)=>{c.setFloat64(e,g(c))}),f("_u32x2",(c,e,g)=>{const h=g(c);c.setUint32(e,h[0]),c.setUint32(e+4,h[1])}),f(["vu8_i32","vi32_i32"],(c,e,g)=>{const h=c.getInt64(e),k=c.getInt64(e+8),l=g(c,k,h);c.setInt32(e+24,l)}),f("j_u32x2",(c,e,g)=>{const h=c.getJSObject(e),k=g(c,h);c.setUint32(e+8,k[0]),c.setUint32(e+12,k[1])}),f(["jvi32_","jvu32_","jvf32_"],(c,e,g)=>{const h=c.getJSObject(e),k=c.getInt64(e+8),l=c.getInt64(e+16);g(c,h,l,k)}),f("ju32x3_",(c,e,g)=>{const h=c.getJSObject(e),k=c.getUint32(e+8),l=c.getUint32(e+12),n=c.getUint32(e+16);g(c,h,k,l,n)}),f("ju32x4_",(c,e,g)=>{const h=c.getJSObject(e),k=c.getUint32(e+8),l=c.getUint32(e+12),n=c.getUint32(e+16),p=c.getUint32(e+20);g(c,h,k,l,n,p)}),f(["jx2vi32_","jx2vu32_","jx2vf32_"],(c,e,g)=>{const h=c.getJSObject(e),k=c.getJSObject(e+8),l=c.getInt64(e+16),n=c.getInt64(e+24);g(c,h,k,n,l)}),f("ju32_",(c,e,g)=>{g(c,c.getJSObject(e),c.getUint32(e+8))}),f("jf32_",(c,e,g)=>{g(c,c.getJSObject(e),c.getFloat32(e+8))}),f("ju32j_",(c,e,g)=>{g(c,c.getJSObject(e),c.getUint32(e+8),c.getJSObject(e+16))}),f("jx2_",(c,e,g)=>{g(c,c.getJSObject(e),c.getJSObject(e+8))}),f("u32_",(c,e,g)=>{g(c,c.getUint32(e-4))});if(!1)for(let c in x);this.initEvents()}log(){console.log.apply(console,arguments)}error(b){console.error(typeof b=="object"&&b.stack?b.stack:String(b))}enableAnimationStats(){if(!this._animationStats){const b=this._animationStats=new N.Stats();b.addGenericPanel({updateInterval:1000},()=>`Go ${N.fmtByteSize(this.gomem.check().buf.byteLength)}`),b.mount(document.body)}}disableAnimationStats(){this._animationStats&&(this._animationStats.unmount(),this._animationStats=null)}updateAnimationStats(b){this._animationStats||this.enableAnimationStats(),this._animationStats.update(b)}getContext(b,d){return b.getContext(d)}main(b){return this.wasmInstance=b,this.go.run(b)}initEvents(){const b=this,d=(e,g,h)=>({ev:0,_jsevent:!0,handler:h,enable(){e.addEventListener(g,this.handler)},disable(){e.removeEventListener(g,this.handler)}}),f=(e,g)=>({ev:e,enable(){b.enablePersistentEvent(e,g)},disable(){b.disablePersistentEvent(e)}}),c=e=>[e.pointerId,e.x*10,e.y*10,e.buttons];b.events={[C]:d(window,"pointermove",c),[D]:d(window,"pointerdown",c),[E]:d(window,"pointerup",c),[B]:d(window,"resize",e=>[window.innerWidth,window.innerHeight]),[y]:f(y)};for(let e in b.events){let g=b.events[e],h=g.ev=parseInt(e);if(g._jsevent){let k=g.handler;g.handler=l=>{b.eventEnqueue(h,k(l))}}}}eventSubscribe(b){u("host.eventSubscribe",b,F(b));for(let d in this.events){let f=this.events[d];b&f.ev&&!this.eventSubscriptions.has(f.ev)&&(this.eventSubscriptions.add(f.ev),f.enable())}}eventUnsubscribe(b){u("host.eventUnsubscribe",b,F(b));for(let d of this.events)b&d.ev&&this.eventSubMask.has(d.ev)&&(d.disable(),this.eventSubscriptions.delete(d.ev),this.transientEvents.delete(d.ev),this.persistentEvents.delete(d.ev))}eventEnqueue(b,d){q(!d||d instanceof Array),this.transientEvents.set(b,d),this.runloopWake&&this.runloopWakeA()}enablePersistentEvent(b,d){this.persistentEvents.set(b,d),this.persistentEventsVersion++,this.runloopWake&&this.runloopWake()}disablePersistentEvent(b){this.persistentEvents.delete(b),this.persistentEventsVersion++}stopRunLoop(){u("Host.stopRunLoop"),this.runloopTickFunc=null}startRunLoop(b,d,f){u("Host.startRunLoop");if(this.runloopTickFunc)throw new Error("runloop already running");const c=performance.now();let e=d;const g=e,h=g+8,k=h+4;let l=0,n=0;const p=o=>{let m=k;for(let[w,r]of this.persistentEvents)m=K(o,m,w,r);l=this.persistentEvents.size,n=m},K=(o,m,w,r)=>{o.setUint32(m,w),m+=4,o.setUint32(m,r?r.length:0),m+=4;if(r)for(let ua of r)o.setUint32(m,ua),m+=4;return m};let L=0,A=0;var v=()=>{if(this.runloopTickFunc!==v)return;let o=this.gomem.check();o.version!=L?(p(o),L=o.version,A=this.persistentEventsVersion):this.persistentEventsVersion!=A&&(A=this.persistentEventsVersion,p(o)),o.setFloat64(g,(performance.now()-c)/1000),o.setUint32(h,l+this.transientEvents.size);if(this.transientEvents.size>0){let m=n;for(let[w,r]of this.transientEvents)m=K(o,m,w,r);this.transientEvents.clear()}this.runloopWake=null,b(),this.persistentEvents.size>0?requestAnimationFrame(v):this.runloopWake=v};this.runloopWakeA=()=>{this.runloopWake=null,requestAnimationFrame(v)},this.runloopTickFunc=v,v()}}(),t=window._appinit;let G=0;t.host=s,t.initCallback=()=>{const a=(performance.now()-G).toFixed(1);console.debug(`wasm initialized in ${a}ms`),delete window._appinit,t.onLoaded&&t.onLoaded()},console.debug(`host boot ${Date.now()-t.time}ms`),(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(t.wasmFetch,s.go.importObject):t.wasmFetch.then(a=>a.arrayBuffer()).then(a=>WebAssembly.instantiate(a,s.go.importObject))).then(a=>{G=performance.now(),s.main(a.instance)});
}},0);
//# sourceMappingURL=host.js.map
